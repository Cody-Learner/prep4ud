#!/bin/bash
# prep4ud 2018-11-30-testing
# Run as root or user.
# Attribute Trilby: https://bbs.archlinux.org/viewtopic.php?pid=1775384#p1775384 , for 'Was' variable awk code:   
# Thanks: Foxboron, Morganamilo, and all others @ reddit.com/r/archlinux/ , for the idea, help and feedback.

# Uzr=$(awk -F':' '/1000/ {print $1}' /etc/passwd)
# Uzr=$(getent passwd 1000 | awk -F':' '{print $1}')
# Uzr=$(who | awk '!/root/ {print $1}')

Uzr=$(who | awk '!/root/ {print $1}' | awk '!seen[$0]++')

if	[[ $(echo "${Uzr}" | wc -l) != 1 ]] ; then 
	echo "Detected more than one non root user logged in."
	echo "Manually set Uzr var in script."
	exit
fi

Pkgcac="/var/cache/prep4ud/pkg"; [[ -d "${Pkgcac}" ]] || sudo mkdir -p "${Pkgcac}"	# Pkgcac  Prep4ud package cache
DataB="/var/lib/prep4ud/"								# DataB   Prep4ud database
Before=$(find "${Pkgcac}" -type f | wc -l)						# Before  Pkgcac package count before updating
Sendto=/home/"${Uzr}"/Desktop/prep4ud.rep/prep4ud-"$(date '+%Y-%m-%d')" 		# Sendto  Path prep4ud sends report 
Lrb=$(uptime -p | awk '{$1=""; print}')							# Lrb     Last reboot date
											# Was     Last update date
#====================================  WAS VARIABLE  ==========================================#

Was=$(awk -F'[][ :-]' ' /upgrade$/ {last = mktime($2 " " $3 " " $4 " " $5 " " $6 " 00")}
	END	{	s = systime() - last;
			d = int(s / 86400);
			h = int((s - d * 86400) / 3600)
			m = int((s - d * 86400 - h * 3600) / 60)
   			printf "%d days, %d hours, %d minutes ago\n", d, h, m
		}     ' /var/log/pacman.log)
#===============================================================================================#

	[[ -d /home/"${Uzr}"/Desktop/prep4ud.rep ]] || mkdir -p /home/"${Uzr}"/Desktop/prep4ud.rep
	[[ -d "${DataB}" ]]                         || sudo mkdir -p "${DataB}"

	touch "${Sendto}"
	# trap 'rm --interactive=never "${DataB}"* ' INT TERM EXIT
 	# Test for first run  [[ -z $(ls -a ${Pkgcac} 2>/dev/null) ]]; then

#======================== NEXT 2 LINES MEAT, everything else potatoes ==========================#

	sudo cp -r /var/lib/pacman/* "${DataB}"
	sudo pacman -Syyuw --dbpath   "${DataB}" --cachedir "${Pkgcac}" --noconfirm

After=$(find "${Pkgcac}" -type f | wc -l)					# After   Pkgcac package count after updating
										# Pkls    Updatable package list
Pkls=$(find "${Pkgcac}" -type f    | \
	awk -F'/'     '{print $6}' | \
	awk -F'-x86'  '{print $1}' | \
	awk -F'-any.' '{print $1}' | sort)

echo [[ ${Before} = "${After}"  ]]
if	[[ ${Before} = "${After}"  ]]; then	# [[ test = "${After}"  ]]   

	echo "     No updates available"
	cat <<-EOF > "${Sendto}"
	Last update  : ${Was}
	Last reboot  :${Lrb} ago

	No updates available
EOF
	exit
    else
	cat <<-EOF > "${Sendto}"
	Last update  : ${Was}
	Last reboot  :${Lrb} ago

	Updates available: ${After}

	${Pkls}
EOF
	chown "${Uzr}" "${Sendto}"
fi
